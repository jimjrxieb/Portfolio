name: main.yml

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'api/**'
      - 'ui/**'
      - 'charts/**'
      - '.github/workflows/main.yml'
      - 'Dockerfile*'
      - 'docker-compose.yml'
      - 'package*.json'
      - 'requirements.txt'
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: jimjrxieb/portfolio

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    name: Code Quality & Security
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          ui/package-lock.json
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'api/requirements.txt'
    
    - name: Install dependencies
      run: |
        npm ci
        cd ui && npm ci
        cd ../api && pip install -r requirements.txt
    
    - name: Run linting
      run: npm run lint
    
    - name: Run formatting check
      run: |
        npm run format
        # Check if formatting changed anything
        if [ -n "$(git diff --name-only)" ]; then
          echo "‚ùå Code formatting issues found. Run 'npm run format' locally."
          git diff
          exit 1
        fi
    
    - name: Run security audit
      run: npm run security
      continue-on-error: true  # Don't fail build on security issues
    
    - name: TypeScript type checking
      run: cd ui && npm run lint -- --max-warnings 0

  build:
    runs-on: ubuntu-latest
    needs: quality-checks
    permissions:
      contents: read
      packages: write
      security-events: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.image-tag }}
      image-digest: ${{ steps.build.outputs.digest }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Generate metadata
      id: meta
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-8)
        IMAGE_TAG="main-${SHORT_SHA}"
        echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        
    - name: Debug Docker context
      run: |
        echo "üìÅ Docker build context contents:"
        ls -la api/
        echo "üìã Requirements files:"
        ls -la api/requirements*.txt || echo "‚ùå Requirements files missing"
        
    - name: Build and push API image
      id: build-api
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./api/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:${{ steps.meta.outputs.image-tag }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:latest
        build-args: |
          BUILD_DATE=${{ github.run_id }}
          BUILD_SHA=${{ steps.meta.outputs.short-sha }}
        cache-from: |
          type=gha,scope=api-build
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:cache
        cache-to: |
          type=gha,scope=api-build,mode=max
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:cache,mode=max
        platforms: linux/amd64
        
    - name: Build and push UI image  
      id: build-ui
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./ui/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:${{ steps.meta.outputs.image-tag }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:latest
        build-args: |
          BUILD_DATE=${{ github.run_id }}
          BUILD_SHA=${{ steps.meta.outputs.short-sha }}
        cache-from: |
          type=gha,scope=ui-build
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:cache
        cache-to: |
          type=gha,scope=ui-build,mode=max
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:cache,mode=max
        platforms: linux/amd64

  security-scan:
    runs-on: ubuntu-latest
    needs: [quality-checks, build]
    permissions:
      security-events: write
      packages: read
      
    steps:
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Run Trivy vulnerability scanner (API)
      uses: aquasecurity/trivy-action@master
      continue-on-error: true
      with:
        image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:${{ needs.build.outputs.image-tag }}'
        format: 'sarif'
        output: 'api-trivy-results.sarif'
        
    - name: Upload API Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('api-trivy-results.sarif') != ''
      with:
        sarif_file: 'api-trivy-results.sarif'
        category: 'trivy-api'
        
    - name: Run Trivy vulnerability scanner (UI)
      uses: aquasecurity/trivy-action@master
      continue-on-error: true  
      with:
        image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:${{ needs.build.outputs.image-tag }}'
        format: 'sarif'
        output: 'ui-trivy-results.sarif'
        
    - name: Upload UI Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('ui-trivy-results.sarif') != ''
      with:
        sarif_file: 'ui-trivy-results.sarif'
        category: 'trivy-ui'

  deploy:
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.build.result == 'success'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check security scan status
      run: |
        if [ "${{ needs.security-scan.result }}" = "success" ]; then
          echo "‚úÖ Security scans completed successfully"
        elif [ "${{ needs.security-scan.result }}" = "failure" ]; then
          echo "‚ö†Ô∏è Security scans failed but deployment continuing"
          echo "   Check security tab for vulnerability details"
        else
          echo "üìä Security scan status: ${{ needs.security-scan.result }}"
        fi
        
    - name: Log in to Docker Hub (for local cluster pulls)
      uses: docker/login-action@v3
      with:
        username: linksrobot
        password: ${{ secrets.DOCKER_CRED }}
        
    - name: Log in to GHCR for pulling images
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull and retag images for Docker Hub
      env:
        IMAGE_TAG: ${{ needs.build.outputs.image-tag }}
      run: |
        echo "üê≥ Pulling from GHCR and pushing to Docker Hub for local cluster access..."
        echo "Debug: IMAGE_TAG = ${IMAGE_TAG}"
        echo "Debug: Looking for images:"
        echo "  API: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:${IMAGE_TAG}"
        echo "  UI: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:${IMAGE_TAG}"
        
        # Check if images exist first
        if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:${IMAGE_TAG} >/dev/null 2>&1; then
          echo "‚úÖ API image found, pulling..."
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:${IMAGE_TAG}
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:${IMAGE_TAG} linksrobot/portfolio-api:${IMAGE_TAG}
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:${IMAGE_TAG} linksrobot/portfolio-api:latest
          docker push linksrobot/portfolio-api:${IMAGE_TAG}
          docker push linksrobot/portfolio-api:latest
          echo "‚úÖ API image pushed to Docker Hub"
        else
          echo "‚ùå API image not found in GHCR, skipping..."
          exit 1
        fi
        
        # Check UI image
        if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:${IMAGE_TAG} >/dev/null 2>&1; then
          echo "‚úÖ UI image found, pulling..."
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:${IMAGE_TAG}
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:${IMAGE_TAG} linksrobot/portfolio-ui:${IMAGE_TAG}
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:${IMAGE_TAG} linksrobot/portfolio-ui:latest
          docker push linksrobot/portfolio-ui:${IMAGE_TAG}
          docker push linksrobot/portfolio-ui:latest
          echo "‚úÖ UI image pushed to Docker Hub"
        else
          echo "‚ùå UI image not found in GHCR, skipping..."
          exit 1
        fi
        
        echo "‚úÖ Images available for local deployment pull"
        
    - name: Create deployment instructions
      env:
        IMAGE_TAG: ${{ needs.build.outputs.image-tag }}
      run: |
        echo "üöÄ Production Deployment Instructions"
        echo "====================================="
        echo ""
        echo "Images built and available:"
        echo "  API: linksrobot/portfolio-api:${IMAGE_TAG}"
        echo "  UI: linksrobot/portfolio-ui:${IMAGE_TAG}"
        echo ""
        echo "To deploy to local cluster serving linksmlm.com:"
        echo "  docker pull linksrobot/portfolio-api:latest"
        echo "  docker pull linksrobot/portfolio-ui:latest"
        echo ""
        echo "Or use deployment script:"
        echo "  ./scripts/deploy-from-registry.sh latest"
        echo ""
        echo "üéØ This workflow builds images but doesn't deploy automatically"
        echo "   since linksmlm.com uses local cluster + Cloudflare tunnel"

  notify:
    runs-on: ubuntu-latest
    needs: [quality-checks, build, security-scan, deploy]
    if: always()
    
    steps:
    - name: Pipeline summary
      run: |
        echo "üéâ Portfolio CI/CD Pipeline Complete!"
        echo ""
        echo "üì¶ Images built and pushed:"
        echo "  API: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:${{ needs.build.outputs.image-tag }}"
        echo "  UI: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:${{ needs.build.outputs.image-tag }}"
        echo ""
        echo "üîí Security scan: ${{ needs.security-scan.result }}"
        echo "üöÄ Deployment: ${{ needs.deploy.result }}"
        echo ""
        echo "üåê Next: Pull images locally and deploy to KinD"
        echo "  Run: ./scripts/deploy-from-registry.sh ${{ needs.build.outputs.image-tag }}"