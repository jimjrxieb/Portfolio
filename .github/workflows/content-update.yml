name: Content Deploy - Fast Knowledge Update

on:
  push:
    branches: [ main ]
    paths:
      - 'data/knowledge/**'
      - 'chat/data/**'

env:
  REGISTRY: docker.io
  IMAGE_NAME: linksrobot/portfolio

jobs:
  content-deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Content Update Analysis
      id: changes
      run: |
        echo "ğŸ“ Knowledge Base Content Updated!"
        echo "================================="
        echo ""
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E "(data/knowledge/|chat/data/)" || echo "")
        echo "Changed files:"
        echo "$CHANGED_FILES"
        echo ""
        
        # Check for Gojo transformation
        if echo "$CHANGED_FILES" | grep -q "gojo"; then
          echo "ğŸ¤– Gojo avatar transformation detected"
          echo "gojo-transform=true" >> $GITHUB_OUTPUT
        fi
        
        if echo "$CHANGED_FILES" | grep -q "01-bio.md"; then
          echo "ğŸ“‹ Biography updates detected"
          echo "bio-update=true" >> $GITHUB_OUTPUT
        fi
        
        if echo "$CHANGED_FILES" | grep -q "personality"; then
          echo "ğŸ­ Personality changes detected"
          echo "personality-update=true" >> $GITHUB_OUTPUT
        fi

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: linksrobot
        password: ${{ secrets.DOCKER_CRED }}

    - name: Update Content in Registry Images
      env:
        IMAGE_TAG: latest
      run: |
        echo "ğŸ”„ Updating content in existing images..."
        
        # Pull latest API image
        docker pull ${REGISTRY}/${IMAGE_NAME}-api:${IMAGE_TAG}
        
        # Create temporary container to update content
        CONTAINER_ID=$(docker create ${REGISTRY}/${IMAGE_NAME}-api:${IMAGE_TAG})
        
        # Copy updated knowledge base
        docker cp data/ ${CONTAINER_ID}:/app/data/
        docker cp chat/ ${CONTAINER_ID}:/app/chat/
        
        # Commit updated container as new image
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-8)
        NEW_TAG="content-${SHORT_SHA}"
        docker commit ${CONTAINER_ID} ${REGISTRY}/${IMAGE_NAME}-api:${NEW_TAG}
        docker tag ${REGISTRY}/${IMAGE_NAME}-api:${NEW_TAG} ${REGISTRY}/${IMAGE_NAME}-api:latest
        
        # Push updated images
        docker push ${REGISTRY}/${IMAGE_NAME}-api:${NEW_TAG}
        docker push ${REGISTRY}/${IMAGE_NAME}-api:latest
        
        # Cleanup
        docker rm ${CONTAINER_ID}
        
        echo "âœ… Content updated in registry"
        echo "new-tag=${NEW_TAG}" >> $GITHUB_ENV

    - name: Create Deployment Instructions
      run: |
        echo "ğŸš€ Fast Content Deployment Ready!"
        echo "================================="
        echo ""
        echo "ğŸ“¦ Updated images available:"
        echo "  API: ${REGISTRY}/${IMAGE_NAME}-api:${{ env.new-tag }}"
        echo "  API: ${REGISTRY}/${IMAGE_NAME}-api:latest"
        echo ""
        echo "ğŸ¯ To deploy to local cluster (serving linksmlm.com):"
        echo "  ./scripts/deploy-from-registry.sh latest"
        echo ""
        echo "ğŸ”§ Or manual deployment:"
        echo "  docker pull ${REGISTRY}/${IMAGE_NAME}-api:latest"
        echo "  kind load docker-image ${REGISTRY}/${IMAGE_NAME}-api:latest --name portfolio-local"
        echo "  helm upgrade portfolio ./charts/portfolio -f charts/portfolio/values.dev.yaml"
        echo ""
        
        if [ "${{ steps.changes.outputs.gojo-transform }}" = "true" ]; then
          echo "ğŸ¤– Gojo Transformation:"
          echo "  â€¢ Avatar changed: Sheyla â†’ Gojo"
          echo "  â€¢ Visual: White hair, crystal blue eyes"
          echo "  â€¢ Voice: Professional male tone"
        fi
        
        if [ "${{ steps.changes.outputs.bio-update }}" = "true" ]; then
          echo "ğŸ“‹ Biography Updates:"
          echo "  â€¢ LinkOps AI-BOX funding information"
          echo "  â€¢ ZRS Management client details"
          echo "  â€¢ Updated technical experience"
        fi
        
        echo ""
        echo "âš¡ Fast deployment: ~2 minutes vs ~10 minutes full build"
        echo "ğŸŒ Test at: https://linksmlm.com after deployment"

  notify-completion:
    runs-on: ubuntu-latest
    needs: content-deploy
    if: always()
    
    steps:
    - name: Deployment Status
      run: |
        if [ "${{ needs.content-deploy.result }}" = "success" ]; then
          echo "âœ… Content deployment succeeded!"
          echo "ğŸ‰ Gojo is ready with updated knowledge"
          echo "ğŸ’¬ Test command: Ask 'Tell me about LinkOps AI-BOX'"
        else
          echo "âŒ Content deployment failed"
          echo "ğŸ”§ Check workflow logs and retry"
        fi