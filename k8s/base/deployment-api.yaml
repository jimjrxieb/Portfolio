apiVersion: apps/v1
kind: Deployment
metadata:
  name: portfolio-api
  namespace: portfolio
  labels: { app: portfolio-api }
spec:
  replicas: 1
  revisionHistoryLimit: 2
  selector: { matchLabels: { app: portfolio-api } }
  template:
    metadata:
      labels: { app: portfolio-api }
    spec:
      securityContext:
        fsGroup: 10001
      initContainers:
        - name: fix-perms
          image: busybox:1.36.1
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
              add: ["CHOWN", "FOWNER"]
            seccompProfile:
              type: RuntimeDefault
          command:
            [
              "sh",
              "-c",
              "mkdir -p /data/uploads/images /data/uploads/audio /data/chroma /data/cache && chown -R 10001:10001 /data && chmod -R 755 /data",
            ]
          volumeMounts:
            - name: data
              mountPath: /data
      containers:
        - name: api
          image: ghcr.io/jimjrxieb/portfolio-api:main-64109c9
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 10001
            runAsGroup: 10001
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
            seccompProfile:
              type: RuntimeDefault
          envFrom:
            - configMapRef: { name: portfolio-config }
            - secretRef: { name: portfolio-secrets }
          ports:
            - containerPort: 8000
          args:
            [
              "uvicorn",
              "app.main:app",
              "--host",
              "0.0.0.0",
              "--port",
              "8000",
              "--workers",
              "1",
            ]
          readinessProbe:
            httpGet: { path: /health, port: 8000 }
            initialDelaySeconds: 40
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 12
          livenessProbe:
            httpGet: { path: /health, port: 8000 }
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 6
          resources:
            requests: { cpu: "200m", memory: "512Mi" }
            limits: { cpu: "1", memory: "2Gi" }
          volumeMounts:
            - name: data
              mountPath: /data
          env:
            - name: UPLOAD_DIR
              value: "/data/uploads"
            - name: CHROMA_DIR
              value: "/data/chroma"
            - name: SENTENCE_TRANSFORMERS_HOME
              value: "/data/cache"
            - name: TRANSFORMERS_CACHE
              value: "/data/cache"
            - name: PUBLIC_BASE_URL
              value: "https://linksmlm.com"
            - name: DATA_DIR
              value: "/data"
            - name: ELEVENLABS_API_KEY
              valueFrom:
                {
                  secretKeyRef:
                    { name: portfolio-secrets, key: ELEVENLABS_API_KEY },
                }
            - name: ELEVENLABS_DEFAULT_VOICE_ID
              valueFrom:
                {
                  secretKeyRef:
                    {
                      name: portfolio-secrets,
                      key: ELEVENLABS_DEFAULT_VOICE_ID,
                    },
                }
            - name: DID_API_KEY
              valueFrom:
                { secretKeyRef: { name: portfolio-secrets, key: DID_API_KEY } }
            - name: LLM_PROVIDER
              value: "openai"
            - name: LLM_API_BASE
              value: "https://api.openai.com"
            - name: LLM_MODEL
              value: "gpt-4o-mini"
            - name: LLM_API_KEY
              valueFrom:
                {
                  secretKeyRef:
                    { name: portfolio-secrets, key: OPENAI_API_KEY },
                }
            - name: CHROMA_URL
              value: "http://chromadb.portfolio.svc.cluster.local:8000"
      # Temporary: skip init container to get API running
      # initContainers:
      #   - name: seed-rag
      #     image: ghcr.io/shadow-link-industries/portfolio-api:updated-rag
      #     imagePullPolicy: IfNotPresent
      #     command: ["python","preprocess.py"]
      #     envFrom:
      #       - configMapRef: { name: portfolio-config }
      #     volumeMounts:
      #       - name: chroma
      #         mountPath: /app/models/chroma
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: chroma-pvc
