# LocalStack Environment Configuration
# Deploys Portfolio infrastructure to LocalStack for local testing

terraform {
  required_version = ">= 1.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = "~> 2.23"
    }
  }
}

# LocalStack Provider Configuration
provider "aws" {
  region                      = "us-east-1"
  access_key                  = "test"
  secret_key                  = "test"
  skip_credentials_validation = true
  skip_metadata_api_check     = true
  skip_requesting_account_id  = true

  # CRITICAL: LocalStack requires path-style S3 access
  # Path-style:         http://localhost:4566/bucket-name/key
  # Virtual hosted-style: http://bucket-name.localhost:4566/key (doesn't work!)
  s3_use_path_style = true

  endpoints {
    s3             = "http://localhost:4566"
    dynamodb       = "http://localhost:4566"
    sqs            = "http://localhost:4566"
    lambda         = "http://localhost:4566"
    cloudwatch     = "http://localhost:4566"
    logs           = "http://localhost:4566"
    events         = "http://localhost:4566"
    iam            = "http://localhost:4566"
    sts            = "http://localhost:4566"
  }
}

# Kubernetes Provider Configuration
# Connects to your Docker Desktop Kubernetes cluster
provider "kubernetes" {
  config_path = "~/.kube/config"
}

# ============================================================================
# PORTFOLIO APPLICATION DEPLOYMENT (Method 2 = Terraform-managed K8s pods)
# ============================================================================
# This deploys the SAME 3 pods as Method 1 (kubectl), but using Terraform!
# - portfolio-ui (React frontend)
# - portfolio-api (FastAPI backend)
# - chroma (ChromaDB vector database)

module "kubernetes_app" {
  source = "./modules/kubernetes-app"

  namespace   = "portfolio"
  environment = "localstack"

  # Docker images (same as Method 1)
  api_image    = "ghcr.io/jimjrxieb/portfolio-api:security-v3"
  ui_image     = "ghcr.io/jimjrxieb/portfolio-ui:vite-fix"
  chroma_image = "chromadb/chroma:0.4.18"

  # API Keys (required for AI features)
  claude_api_key     = var.claude_api_key
  openai_api_key     = var.openai_api_key
  elevenlabs_api_key = var.elevenlabs_api_key
  did_api_key        = var.did_api_key

  # Resource limits (keep same as Method 1 for now)
  api_replicas    = 1
  ui_replicas     = 1
  chroma_replicas = 1
}

# ============================================================================
# AWS STORAGE RESOURCES (Optional Enhancements via LocalStack)
# ============================================================================
# These are OPTIONAL tools/enhancements - the app works without them!
# - S3 buckets for document storage
# - DynamoDB tables for metadata
# - SQS queues for async processing

# Storage Module (S3, DynamoDB, SQS)
module "storage" {
  source = "./modules/aws-resources/storage"

  project_name = var.project_name
  environment  = "localstack"

  tags = {
    Environment = "localstack"
    ManagedBy   = "terraform"
    Purpose     = "local-development"
  }
}

# EventBridge Rule: Daily Reindex (2 AM)
resource "aws_cloudwatch_event_rule" "daily_reindex" {
  name                = "${var.project_name}-daily-reindex"
  description         = "Trigger daily reindex at 2 AM"
  schedule_expression = "cron(0 2 * * ? *)"

  tags = {
    Environment = "localstack"
    ManagedBy   = "terraform"
  }
}

# EventBridge Rule: Process Monitoring (every 5 minutes)
resource "aws_cloudwatch_event_rule" "process_monitoring" {
  name                = "${var.project_name}-process-monitoring"
  description         = "Monitor processes every 5 minutes"
  schedule_expression = "rate(5 minutes)"

  tags = {
    Environment = "localstack"
    ManagedBy   = "terraform"
  }
}
