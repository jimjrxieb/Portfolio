version: '3.8'

services:
  # ChromaDB Vector Database Service
  chromadb:
    image: chromadb/chroma:latest
    ports:
    - "8001:8000"
    volumes:
    - ./data/chroma:/chroma/data
    environment:
    - CHROMA_DB_IMPL=duckdb+parquet
    - CHROMA_PERSIST_DIRECTORY=/chroma/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API Backend Service (Claude + RAG)
    security_opt:
    - no-new-privileges:true
    read_only: true
  api:
    build:
      context: .
      dockerfile: ./api/Dockerfile
    ports:
    - "8000:8000"
    environment:
      # ChromaDB
    - CHROMA_URL=http://chromadb:8000
    - DATA_DIR=/home/jimmie/linkops-industries/Portfolio/data
      # LLM Configuration (Claude)
    - LLM_PROVIDER=claude
    - CLAUDE_API_KEY=${CLAUDE_API_KEY:-}
    - LLM_MODEL=claude-3-5-sonnet-20241022
      # Ollama Embeddings
    - OLLAMA_URL=http://host.docker.internal:11434
    - EMBED_MODEL=nomic-embed-text
      # Fallback (OpenAI)
    - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    - PYTHONPATH=/app
    volumes:
    - ./data/chroma:/home/jimmie/linkops-industries/Portfolio/data/chroma
    - ./data/uploads:/home/jimmie/linkops-industries/Portfolio/data/uploads
    depends_on:
    - chromadb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    extra_hosts:
    - "host.docker.internal:host-gateway"

  # Frontend UI Service
  ui:
    build:
      context: .
      dockerfile: ./ui/Dockerfile
    ports:
    - "3000:80"
    environment:
    - VITE_API_URL=http://localhost:8000
    - VITE_CHROMA_URL=http://localhost:8001
    depends_on:
    - api
    restart: unless-stopped

  # Local Development Only - RAG Pipeline for data ingestion
  # Uncomment when you need to ingest new data on ROG Strix
  # rag-pipeline:
  #   build:
  #     context: .
  #     dockerfile: ./rag-pipeline/Dockerfile.api
  #   ports:
  #     - "8003:8000"
  #   environment:
  #     - CHROMA_URL=http://chromadb:8000
  #     - GPT_MODEL=gpt-4o-mini
  #     - OPENAI_API_KEY=${OPENAI_API_KEY:-}
  #   volumes:
  #     - ./data/knowledge:/app/knowledge
  #     - ./data/chroma:/app/chroma
  #   depends_on:
  #     - chromadb
  #   profiles:
  #     - dev-tools

volumes:
  chroma-data:

networks:
  default:
    name: portfolio-network
