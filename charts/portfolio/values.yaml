# Portfolio Helm Chart Values
# CI/CD Pipeline will only mutate image.tag

# Image Configuration (CI Pipeline touches these)
image:
  repository: ghcr.io/shadow-link-industries/portfolio-api
  tag: "main-latest"  # CI updates this to main-<shortsha>
  pullPolicy: IfNotPresent

ui:
  image:
    repository: ghcr.io/shadow-link-industries/portfolio-ui
    tag: "main-latest"  # CI updates this to main-<shortsha>
    pullPolicy: IfNotPresent

# Application Configuration
replicaCount: 1

# Service Configuration
service:
  api:
    type: ClusterIP
    port: 8000
    targetPort: 8000
  ui:
    type: ClusterIP
    port: 80
    targetPort: 8080

# Ingress Configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Content-Type, Authorization"
  host: portfolio.localtest.me
  tls: false

# Resource Limits
resources:
  api:
    requests:
      cpu: "200m"
      memory: "512Mi"
    limits:
      cpu: "1"
      memory: "2Gi"
  ui:
    requests:
      cpu: "50m"
      memory: "128Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"

# Security Context
securityContext:
  runAsNonRoot: true
  runAsUser: 10001
  runAsGroup: 10001
  fsGroup: 10001
  seccompProfile:
    type: RuntimeDefault

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 10001

containerSecurityContext:
  runAsNonRoot: true
  runAsUser: 10001
  runAsGroup: 10001
  readOnlyRootFilesystem: true  # Security: Enable read-only root filesystem
  allowPrivilegeEscalation: false
  privileged: false
  capabilities:
    drop:
      - ALL
    add: []  # No additional capabilities needed
  seccompProfile:
    type: RuntimeDefault
  seLinuxOptions:
    type: container_t

# Init container security (for permission fixing)
initContainerSecurityContext:
  runAsNonRoot: false  # Required for chown operations
  runAsUser: 0
  runAsGroup: 0
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  privileged: false
  capabilities:
    drop:
      - ALL
    add:
      - CHOWN  # Only capability needed for permission fixes
      - FOWNER
  seccompProfile:
    type: RuntimeDefault

# Network Policy Configuration
networkPolicy:
  enabled: true
  ingressNamespace: "ingress-nginx"  # Adjust based on your ingress controller

# Pod Security Standards (K8s 1.23+) - PSP deprecated in 1.25+
podSecurityStandards:
  enabled: true
  enforce: "restricted"
  audit: "restricted"
  warn: "restricted"

# Resource Limits (Security)
resourceQuotas:
  enabled: true
  hard:
    requests.cpu: "2"
    requests.memory: "4Gi"
    limits.cpu: "4"
    limits.memory: "8Gi"
    persistentvolumeclaims: "2"

# Security Scanning
securityScanning:
  enabled: true
  admissionController: true
  runtime: true

# Gatekeeper (OPA admission controller)
gatekeeper:
  enabled: true
  allowedRegistries:
    - "ghcr.io/"
    - "chromadb/"
    - "busybox:"
  requireSignedImages: true
  blockPrivileged: true
  requireResourceLimits: true

# Falco runtime security monitoring
falco:
  enabled: true
  alerts:
    webhook:
      enabled: false
      url: ""
    slack:
      enabled: false
      webhook: ""
    email:
      enabled: false
      smtp:
        server: ""
        port: 587
        username: ""
        password: ""
        to: ""
  rules:
    privilegeEscalation: true
    fileModification: true
    networkActivity: true
    shellAccess: true
    packageManager: true
    sensitiveFiles: true
    cryptoMining: true
    containerEscape: true
    unexpectedExecution: true

# Health Probes
probes:
  api:
    readinessProbe:
      httpGet:
        path: /health
        port: 8000
      initialDelaySeconds: 40
      periodSeconds: 5
      timeoutSeconds: 2
      failureThreshold: 12
    livenessProbe:
      httpGet:
        path: /health
        port: 8000
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 2
      failureThreshold: 6
  ui:
    readinessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 10
      periodSeconds: 5
    livenessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 15
      periodSeconds: 30

# Environment Variables (non-secret)
env:
  api:
    LLM_PROVIDER: "openai"
    LLM_MODEL: "gpt-4o-mini"
    LLM_API_BASE: "https://api.openai.com"
    EMBED_MODEL: "sentence-transformers/all-MiniLM-L6-v2"
    API_PORT: "8000"
    API_HOST: "0.0.0.0"
    CORS_ALLOW_ORIGINS: "*"
    RAG_NAMESPACE: "portfolio"
  ui:
    VITE_API_BASE_URL: "http://portfolio.localtest.me/api"

# Secret References (external secrets)
secretRefs:
  api:
    - name: portfolio-api-secrets
      keys:
        - OPENAI_API_KEY
        - ELEVENLABS_API_KEY
        - DID_API_KEY

# Persistence
persistence:
  enabled: true
  storageClass: ""
  accessMode: ReadWriteOnce
  size: 10Gi
  mountPath: /data

# Optional Components (for lean KinD deployment)
chroma:
  enabled: true
  image:
    repository: chromadb/chroma
    tag: "0.4.18"
    pullPolicy: IfNotPresent
  service:
    port: 8000
  persistence:
    enabled: true
    size: 5Gi

# Node Selector / Affinity
nodeSelector: {}
tolerations: []
affinity: {}

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""
  automountServiceAccountToken: false  # Security: disable auto-mounting tokens

# Pod Annotations
podAnnotations: {}

# Pod Labels
podLabels: {}

# Autoscaling (disabled for now)
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80