# Portfolio Helm Chart Values
# CI/CD Pipeline will only mutate image.tag

# Image Configuration (CI Pipeline touches these)
image:
  repository: ghcr.io/shadow-link-industries/portfolio-api
  tag: "main-latest"  # CI updates this to main-<shortsha>
  pullPolicy: IfNotPresent

ui:
  image:
    repository: ghcr.io/shadow-link-industries/portfolio-ui
    tag: "main-latest"  # CI updates this to main-<shortsha>
    pullPolicy: IfNotPresent

# Application Configuration
replicaCount: 1

# Service Configuration
service:
  api:
    type: ClusterIP
    port: 8000
    targetPort: 8000
  ui:
    type: ClusterIP
    port: 80
    targetPort: 80

# Ingress Configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Content-Type, Authorization"
  host: portfolio.localtest.me
  tls: false

# Resource Limits
resources:
  api:
    requests:
      cpu: "200m"
      memory: "512Mi"
    limits:
      cpu: "1"
      memory: "2Gi"
  ui:
    requests:
      cpu: "50m"
      memory: "128Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"

# Security Context
securityContext:
  runAsNonRoot: true
  runAsUser: 10001
  runAsGroup: 10001
  fsGroup: 10001
  seccompProfile:
    type: RuntimeDefault

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 10001
  runAsGroup: 10001

containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false  # API needs write for ChromaDB
  capabilities:
    drop:
      - ALL

# Health Probes
probes:
  api:
    readinessProbe:
      httpGet:
        path: /health
        port: 8000
      initialDelaySeconds: 40
      periodSeconds: 5
      timeoutSeconds: 2
      failureThreshold: 12
    livenessProbe:
      httpGet:
        path: /health
        port: 8000
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 2
      failureThreshold: 6
  ui:
    readinessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 10
      periodSeconds: 5
    livenessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 15
      periodSeconds: 30

# Environment Variables (non-secret)
env:
  api:
    LLM_PROVIDER: "openai"
    LLM_MODEL: "gpt-4o-mini"
    LLM_API_BASE: "https://api.openai.com"
    EMBED_MODEL: "sentence-transformers/all-MiniLM-L6-v2"
    CHROMA_DIR: "/data/chroma"
    DATA_DIR: "/data"
    API_PORT: "8000"
    API_HOST: "0.0.0.0"
    CORS_ALLOW_ORIGINS: "*"
    RAG_NAMESPACE: "portfolio"
  ui:
    VITE_API_BASE_URL: "http://portfolio.localtest.me/api"

# Secret References (external secrets)
secretRefs:
  api:
    - name: portfolio-api-secrets
      keys:
        - OPENAI_API_KEY
        - ELEVENLABS_API_KEY
        - DID_API_KEY

# Persistence
persistence:
  enabled: true
  storageClass: ""
  accessMode: ReadWriteOnce
  size: 10Gi
  mountPath: /data

# Optional Components (for lean KinD deployment)
chroma:
  enabled: true
  image:
    repository: chromadb/chroma
    tag: "0.4.18"
    pullPolicy: IfNotPresent
  service:
    port: 8000
  persistence:
    enabled: true
    size: 5Gi

# Node Selector / Affinity
nodeSelector: {}
tolerations: []
affinity: {}

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Pod Annotations
podAnnotations: {}

# Pod Labels
podLabels: {}

# Autoscaling (disabled for now)
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80