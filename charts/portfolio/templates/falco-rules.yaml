{{- if .Values.falco.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "portfolio.fullname" . }}-falco-rules
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "portfolio.labels" . | nindent 4 }}
data:
  portfolio_rules.yaml: |
    # Portfolio-specific Falco security rules

    # Detect privilege escalation attempts
    - rule: Privilege Escalation in Portfolio
      desc: Detect privilege escalation attempts in portfolio containers
      condition: >
        spawned_process and
        container and
        k8s.ns.name = "{{ .Release.Namespace }}" and
        (proc.name in (sudo, su, doas)) and
        not user.name = root
      output: >
        Privilege escalation attempt in portfolio container
        (user=%user.name command=%proc.cmdline container=%container.name
        k8s.pod=%k8s.pod.name)
      priority: WARNING
      tags: [portfolio, privilege_escalation, mitre_privilege_escalation]

    # Detect unexpected file modifications
    - rule: Unauthorized File Modification in Portfolio
      desc: Detect unauthorized file modifications in portfolio containers
      condition: >
        open_write and
        container and
        k8s.ns.name = "{{ .Release.Namespace }}" and
        fd.name startswith /etc and
        not proc.name in (package-manager, apt, yum, apk, npm, pip)
      output: >
        Unauthorized file modification in portfolio container
        (file=%fd.name proc=%proc.name container=%container.name
        k8s.pod=%k8s.pod.name)
      priority: WARNING
      tags: [portfolio, file_modification, persistence]

    # Detect network activity from unexpected processes
    - rule: Unexpected Network Activity in Portfolio
      desc: Detect network connections from unexpected processes
      condition: >
        inbound_outbound and
        container and
        k8s.ns.name = "{{ .Release.Namespace }}" and
        not proc.name in (python, python3, node, nginx, uvicorn, gunicorn)
      output: >
        Unexpected network activity in portfolio container
        (connection=%fd.name proc=%proc.name container=%container.name
        k8s.pod=%k8s.pod.name)
      priority: NOTICE
      tags: [portfolio, network, lateral_movement]

    # Detect shell access in containers (should not happen in production)
    - rule: Shell Access in Portfolio Container
      desc: Detect shell access in portfolio containers
      condition: >
        spawned_process and
        container and
        k8s.ns.name = "{{ .Release.Namespace }}" and
        proc.name in (bash, sh, zsh, fish, csh, tcsh) and
        not proc.pname in (docker, kubectl, containerd, systemd)
      output: >
        Shell access detected in portfolio container
        (shell=%proc.name user=%user.name container=%container.name
        k8s.pod=%k8s.pod.name)
      priority: WARNING
      tags: [portfolio, shell_access, execution]

    # Detect package manager usage (should not happen in production)
    - rule: Package Manager Usage in Portfolio
      desc: Detect package manager usage in portfolio containers
      condition: >
        spawned_process and
        container and
        k8s.ns.name = "{{ .Release.Namespace }}" and
        proc.name in (apt, apt-get, yum, dnf, apk, npm, pip, pip3, pipenv, poetry)
      output: >
        Package manager usage in portfolio container
        (package_manager=%proc.name command=%proc.cmdline container=%container.name
        k8s.pod=%k8s.pod.name)
      priority: WARNING
      tags: [portfolio, package_management, persistence]

    # Detect sensitive file access
    - rule: Sensitive File Access in Portfolio
      desc: Detect access to sensitive files
      condition: >
        open_read and
        container and
        k8s.ns.name = "{{ .Release.Namespace }}" and
        (fd.name startswith /etc/passwd or
         fd.name startswith /etc/shadow or
         fd.name startswith /etc/ssh or
         fd.name contains "id_rsa" or
         fd.name contains "id_dsa" or
         fd.name contains ".pem" or
         fd.name contains "private" or
         fd.name contains "secret" or
         fd.name contains "token")
      output: >
        Sensitive file access in portfolio container
        (file=%fd.name proc=%proc.name container=%container.name
        k8s.pod=%k8s.pod.name)
      priority: ERROR
      tags: [portfolio, sensitive_files, credential_access]

    # Detect crypto mining activity
    - rule: Crypto Mining in Portfolio
      desc: Detect potential crypto mining activity
      condition: >
        spawned_process and
        container and
        k8s.ns.name = "{{ .Release.Namespace }}" and
        (proc.name contains "miner" or
         proc.name contains "xmrig" or
         proc.name contains "cryptonight" or
         proc.cmdline contains "pool" or
         proc.cmdline contains "stratum")
      output: >
        Potential crypto mining activity in portfolio container
        (proc=%proc.name command=%proc.cmdline container=%container.name
        k8s.pod=%k8s.pod.name)
      priority: CRITICAL
      tags: [portfolio, crypto_mining, resource_hijacking]

    # Detect container escape attempts
    - rule: Container Escape Attempt in Portfolio
      desc: Detect potential container escape attempts
      condition: >
        spawned_process and
        container and
        k8s.ns.name = "{{ .Release.Namespace }}" and
        (proc.name in (docker, containerd, runc) or
         proc.cmdline contains "/proc/self/exe" or
         proc.cmdline contains "chroot" or
         proc.cmdline contains "unshare")
      output: >
        Container escape attempt in portfolio container
        (proc=%proc.name command=%proc.cmdline container=%container.name
        k8s.pod=%k8s.pod.name)
      priority: CRITICAL
      tags: [portfolio, container_escape, privilege_escalation]

    # Detect unexpected binary execution
    - rule: Unexpected Binary Execution in Portfolio
      desc: Detect execution of unexpected binaries
      condition: >
        spawned_process and
        container and
        k8s.ns.name = "{{ .Release.Namespace }}" and
        proc.name in (wget, curl, nc, netcat, ncat, socat, nmap, masscan) and
        not proc.pname in (python, python3, node, npm, pip)
      output: >
        Unexpected binary execution in portfolio container
        (binary=%proc.name command=%proc.cmdline container=%container.name
        k8s.pod=%k8s.pod.name)
      priority: WARNING
      tags: [portfolio, unexpected_execution, reconnaissance]
{{- end }}